trigger:
  branches:
    include:
      - master
      - feature/*
  paths:
    include:
      - npm

pool:
  name: Helsenorge_LinuxScaleSetAgents

variables:
  - name: node_version
    value: 24
  - name: npm_version
    value: '11.6.2'
  - name: HUSKY
    value: 0
  - name: branchName
    value: $[ replace(variables['Build.SourceBranch'], 'refs/heads/', '') ]
  - name: accountName
    value: frankensteinstorybook
  - name: container
    value: $web

stages:
  - stage:
    displayName: Deploy Storybook
    jobs:
      - job:
        displayName: Deploy Storybook
        steps:
          - task: UseNode@1
            displayName: Use Node version
            inputs:
              version: $(node_version)
          - script: npm i -g npm@$(npm_version)
            displayName: Use npm $(npm_version)

          - script: npm ci
            displayName: Install dependencies

          - script: npm run build --workspace=npm/build-tools
            displayName: Build frankenstein-build-tools

          - script: npm run build --workspace=@helsenorge/datepicker
            displayName: Build @helsenorge/datepicker

          - script: npm run build-storybook --workspace=npm/designsystem -- -o dist/$(branchName)
            displayName: Build Storybook
            env:
              STORYBOOK_BASE_PATH: /$(branchName)/

          - task: AzureCLI@2
            displayName: Copy to Azure Storage account
            inputs:
              azureSubscription: $(AZURE_SUBSCRIPTION)
              scriptType: pscore
              scriptLocation: inlineScript
              inlineScript: |
                az storage blob delete-batch --account-name $(accountName) --source '$(container)' --pattern "$(branchName)/*"
                az storage blob upload-batch --account-name $(accountName) --destination '$(container)' --destination-path $(branchName) --source npm/designsystem/dist/$(branchName)
